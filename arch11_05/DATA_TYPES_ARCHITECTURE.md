# Архитектура системы загрузки данных о недвижимости

## Анализ несоответствий типов данных

В ходе работы системы были выявлены несоответствия между типами данных в CSV-файлах, получаемых из API Bayut, и структурой таблицы в PostgreSQL. Ниже представлены результаты анализа и рекомендации для улучшения архитектуры системы.

### Выявленные проблемы

1. **Несоответствие типов данных**
   - Некоторые колонки в таблице базы данных имели числовые типы (integer, numeric), в то время как данные из API содержали строковые значения.
   - Колонка "Unnamed: 25" (isVerified) в CSV имела тип boolean, а в базе данных была числовой.
   - Колонка "Unnamed: 26" (purpose) содержала строковые значения (for-sale), но имела тип integer в базе.
   - Специальные символы Unicode в данных вызывали ошибки при загрузке в базу данных из-за проблем кодировки.

2. **Проблемы надежности**
   - Монолитный скрипт выполнял как загрузку из API, так и загрузку в базу данных, что приводило к повторной загрузке данных при ошибке на этапе работы с БД.
   - Отсутствие предварительной обработки данных перед загрузкой в БД.

### Внесенные изменения

1. **Разделение на этапы**
   - Создан двухэтапный процесс: `api_to_csv.py` для загрузки из API в CSV и `csv_to_sql.py` для загрузки из CSV в SQL.
   - Данный подход увеличивает отказоустойчивость и позволяет повторять только необходимый этап в случае ошибки.

2. **Предварительная обработка данных**
   - Добавлена очистка и нормализация данных перед загрузкой в базу данных.
   - Реализовано преобразование типов данных для обеспечения совместимости.
   - Добавлена обработка специальных символов Unicode.

3. **Анализ структуры данных**
   - Разработан скрипт `analyze_csv_structure.py` для анализа и сравнения структуры CSV и таблицы SQL.
   - Реализовано автоматическое определение рекомендуемых типов данных для колонок.

4. **Изменение структуры базы данных**
   - Типы данных колонок в PostgreSQL приведены в соответствие с фактическими данными.
   - Создан скрипт для автоматического применения изменений структуры таблицы.

## Рекомендации по архитектуре

### 1. Стандартизация и документирование схемы данных

Необходимо создать и поддерживать в актуальном состоянии документацию по структуре данных:
- Описание каждой колонки, ее назначения и допустимых значений
- Четко определенные типы данных для всех полей
- Связи между таблицами и внешние ключи (при расширении системы)

### 2. Управление схемой данных

- **Миграции базы данных**: Внедрить систему миграций (например, Alembic, Flyway) для управления изменениями схемы БД
- **Версионирование**: Версионировать схему данных для отслеживания изменений
- **Валидация**: Добавить автоматическую валидацию схемы при обновлении системы

### 3. Улучшение процесса загрузки данных

- **Предварительная проверка**: Перед загрузкой проверять соответствие данных ожидаемой схеме
- **Валидация данных**: Реализовать проверки целостности и качества данных
- **Логирование ошибок**: Улучшить систему логирования с детальной информацией о проблемных данных
- **Мониторинг**: Добавить мониторинг процесса загрузки с оповещениями о проблемах

### 4. Гибкость при работе с внешним API

- **Проверка структуры API**: Регулярно проверять, не изменилась ли структура данных в API
- **Адаптеры для API**: Создать адаптеры для преобразования данных из API в стандартный формат
- **Версионирование API**: Отслеживать и обрабатывать различные версии API

### 5. Дополнительные улучшения

- **Кэширование**: Реализовать кэширование частых запросов для повышения производительности
- **Индексирование**: Добавить соответствующие индексы в базу данных для часто используемых запросов
- **Партиционирование**: При росте объема данных рассмотреть партиционирование таблиц
- **Архивирование**: Внедрить политику архивирования старых данных

## Технический стек для модернизации системы

- **БД**: PostgreSQL с использованием JSON/JSONB для гибких структур данных
- **ORM**: SQLAlchemy для типизированного доступа к БД
- **Миграции**: Alembic для управления схемой БД
- **Валидация**: Pydantic для валидации данных
- **Мониторинг**: Prometheus + Grafana для отслеживания работы системы
- **Оркестрация**: Airflow для управления рабочими процессами

## Заключение

Внедрение предложенных изменений и рекомендаций позволит создать более надежную, гибкую и масштабируемую систему загрузки и обработки данных о недвижимости. Разделение процесса на этапы и добавление предварительной обработки данных существенно повысили стабильность работы системы и упростили диагностику проблем. 