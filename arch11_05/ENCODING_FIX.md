# Исправление проблем с кодировкой в WealthCompas

## Обзор проблемы

При анализе данных о недвижимости в Дубае возникла проблема с кодировкой:
```
character with byte sequence 0x98 in encoding "WIN1251" has no equivalent in encoding "UTF8"
```

Эта ошибка происходит из-за несоответствия между кодировкой WIN1251 (кириллица в Windows) и UTF-8, что приводит к неправильному отображению текстовых данных в базе данных и невозможности корректно выполнить SQL-запросы.

## Решение

Для решения проблемы были внесены следующие изменения:

1. **Улучшение процесса загрузки CSV-файлов**:
   - Создан новый скрипт `load_csv_fixed.py`, который автоматически определяет кодировку исходного файла и преобразует его в UTF-8
   - Добавлена явная установка кодировки соединения с базой данных

2. **Улучшение обработки данных в существующем коде**:
   - Добавлены методы для обработки строк с неподдерживаемыми символами
   - Включена дополнительная обработка ошибок для корректной работы даже при возникновении проблем кодировки

## Как использовать новые скрипты

### 1. Загрузка данных с исправлением кодировки

```bash
# Перед загрузкой установите необходимые зависимости
pip install chardet pandas

# Запустите скрипт для загрузки данных с исправлением кодировки
python load_csv_fixed.py
```

Этот скрипт:
1. Определит кодировку исходного CSV-файла
2. Преобразует данные в UTF-8
3. Создаст новый файл с исправленной кодировкой
4. Загрузит исправленные данные в базу данных

### 2. Тестирование запросов после исправления

```bash
# Запустите тестовый скрипт для проверки запросов
python test_top3_fixed.py
```

Этот скрипт проверит:
1. Корректность получения топ-3 квартир по районам
2. Генерацию аналитических ответов на вопросы пользователя
3. Обработку различных формулировок запросов

## Дополнительные рекомендации

1. **Проверка кодировки соединения**:
   - Всегда используйте параметр `client_encoding='utf8'` в параметрах подключения к базе данных
   - Добавляйте явную установку кодировки: `conn.set_client_encoding('UTF8')`

2. **Обработка текстовых данных**:
   - При работе с текстом добавляйте проверку и конвертацию строк:
   ```python
   if isinstance(value, str):
       value = value.encode('utf-8', 'ignore').decode('utf-8')
   ```

3. **Стандартизация CSV-файлов**:
   - При получении новых CSV-файлов всегда преобразуйте их в UTF-8 перед загрузкой
   - Используйте функцию `preprocess_csv` из скрипта `load_csv_fixed.py`

## Проверка исправлений

После успешной загрузки данных запустите бота и проверьте выполнение запросов:
```bash
python main.py
```

Теперь ваш WealthCompas Telegram-бот должен корректно анализировать данные о недвижимости в Дубае без проблем с кодировкой. 