# Двухэтапная система загрузки данных API Bayut

Система предназначена для автоматической ежедневной загрузки данных о недвижимости из API Bayut, сохранения их в CSV файлы и загрузки в базу данных PostgreSQL с использованием двухэтапного процесса.

## Преимущества двухэтапного подхода

1. **Надежность** - если произойдет ошибка на этапе загрузки в базу данных, не нужно повторно запрашивать данные из API
2. **Гибкость** - возможность запускать только один из этапов по необходимости
3. **Отказоустойчивость** - промежуточные CSV-файлы служат точками восстановления
4. **Изоляция ошибок** - проблемы на одном этапе не влияют на другой
5. **Упрощенная отладка** - каждый этап имеет собственные логи

## Структура системы

Система состоит из следующих компонентов:

- **api_to_csv.py** - скрипт для загрузки данных из API и сохранения в CSV
- **csv_to_sql.py** - скрипт для загрузки данных из CSV в базу данных PostgreSQL
- **schedule_daily_load.py** - планировщик для автоматического ежедневного запуска
- **logs/** - директория с логами выполнения скриптов
- **Api_Bayat/archive/** - архивная директория для обработанных CSV файлов

## Процесс работы

1. Скрипт `api_to_csv.py`:
   - Получает дату последнего обновления из БД
   - Загружает новые данные из API Bayut
   - Сохраняет данные в CSV-файл
   - Возвращает путь к созданному CSV-файлу

2. Скрипт `csv_to_sql.py`:
   - Получает путь к CSV-файлу из аргументов или stdin
   - Загружает данные из CSV в базу данных
   - Перемещает обработанный CSV-файл в архив

3. Планировщик `schedule_daily_load.py`:
   - Запускает `api_to_csv.py`
   - Получает путь к созданному CSV-файлу
   - Запускает `csv_to_sql.py` с указанным путем к файлу
   - Логирует результаты выполнения каждого этапа

## Логирование

Система использует подробное логирование для каждого этапа:

- `logs/api_to_csv_YYYYMMDD_HHMMSS.log` - логи этапа загрузки из API в CSV
- `logs/csv_to_sql_YYYYMMDD_HHMMSS.log` - логи этапа загрузки из CSV в БД
- `logs/scheduler_YYYYMMDD.log` - логи планировщика

## Использование

### Запуск полного процесса через планировщик

```bash
# Запуск загрузки немедленно
python schedule_daily_load.py --now

# Запуск планировщика в фоновом режиме
python schedule_daily_load.py --daemon
```

### Раздельный запуск этапов

```bash
# Только загрузка из API в CSV
python api_to_csv.py

# Только загрузка из CSV в SQL
python csv_to_sql.py /путь/к/файлу.csv
```

### Передача данных между этапами

Скрипт `api_to_csv.py` выводит путь к созданному файлу в формате:

```
CSV_PATH:/путь/к/файлу.csv
```

Это позволяет передавать путь между скриптами через пайпы:

```bash
python api_to_csv.py | python csv_to_sql.py
```

## Восстановление после ошибок

1. **Ошибка на этапе API_to_CSV**: 
   - Проверить логи в `logs/api_to_csv_*.log`
   - Исправить проблему и перезапустить скрипт

2. **Ошибка на этапе CSV_to_SQL**:
   - Проверить логи в `logs/csv_to_sql_*.log`
   - Исправить проблему (например, несоответствие типов данных)
   - Запустить только `csv_to_sql.py` с указанием пути к файлу CSV

## Поддержка и развитие

Для дальнейшего развития системы можно:

1. Добавить мониторинг и оповещения о проблемах
2. Расширить функциональность для работы с другими API
3. Внедрить систему контроля качества данных
4. Разработать веб-интерфейс для управления процессом загрузки 