# Миграция на новую структуру данных WealthCompas

## О миграции

Этот документ описывает процесс миграции системы WealthCompas с устаревшей структуры базы данных (с полями "Unnamed: X") на новую структуру с понятными именами полей, соответствующими API.

## Причины миграции

1. **Улучшение читаемости кода**: замена непонятных имен полей ("Unnamed: X") на информативные имена, соответствующие данным из API.
2. **Упрощение сопровождения**: с понятными именами полей проще обновлять и расширять код.
3. **Соответствие стандартам**: приведение структуры базы данных к общепринятым стандартам.

## Изменения в структуре базы данных

| Старое имя поля | Новое имя поля | Описание |
|-----------------|----------------|----------|
| id              | id             | Уникальный идентификатор объявления |
| Unnamed: 1      | title          | Название объявления |
| Unnamed: 2      | price          | Цена объекта недвижимости |
| Unnamed: 3      | rooms          | Количество комнат |
| Unnamed: 4      | baths          | Количество ванных комнат |
| Unnamed: 5      | area           | Площадь объекта недвижимости |
| Unnamed: 6      | rent_frequency | Частота аренды |
| Unnamed: 7      | location       | Данные о местоположении (JSON) |
| Unnamed: 8      | cover_photo_url| URL основной фотографии |
| Unnamed: 9      | property_url   | Ссылка на объявление |
| Unnamed: 10     | category       | Категория объекта |
| Unnamed: 11     | property_type  | Тип объекта недвижимости |
| Unnamed: 12     | created_at     | Дата создания объявления |
| Unnamed: 13     | updated_at     | Дата обновления объявления |
| ...             | ...            | ... |

## Обновленные файлы

1. **data_loader.py** - Скрипт для полного процесса загрузки данных
2. **data_publisher.py** - Скрипт для публикации данных
3. **find_cheapest_apartments_langchain.py** - Скрипт для поиска самых дешевых квартир
4. **api_to_csv.py** - Скрипт для получения данных из API
5. **csv_to_sql.py** - Скрипт для загрузки данных из CSV в базу данных
6. **telegram_simple_publisher.py** - Скрипт для публикации данных в Telegram

## Процесс миграции

Для выполнения миграции запустите скрипт:

```bash
python migrate_to_new_system.py
```

Скрипт выполнит следующие действия:
1. Создаст резервную копию всех старых файлов
2. Выполнит миграцию базы данных (переименует столбцы)
3. Заменит старые файлы на новые версии

## Подтверждение успешной миграции

После миграции проверьте следующее:
1. Структуру таблицы в базе данных
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'bayut_properties'
ORDER BY ordinal_position;
```

2. Запустите процесс загрузки и публикации:
```bash
python data_loader.py
python data_publisher.py
```

## Откат миграции (при необходимости)

Если что-то пошло не так, вы можете восстановить старую версию из созданной резервной копии:
1. Скопируйте файлы из каталога backup_YYYYMMDD_HHMMSS в рабочий каталог
2. Восстановите базу данных из резервной копии (bayut_properties_backup) 